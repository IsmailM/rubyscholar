#!/usr/bin/env ruby

require 'rubygems'
require 'optparse'  # YW is this needed or redundant with commander?
require 'commander/import'
require 'yaml'
require 'rubyscholar'


program :name, 'rubyscholar'
program :version, Rubyscholar::VERSION
program :description, 'Rubyscholar scrapes google scholar and formats it into a scholar.html file.'

default_command :scrape

command :scrape do |c|
  c.syntax = 'rubyscholar scrape [options]'
  c.description = "Scrape Google Scholar for new publications"

  c.option '--config [Config File]', 'Config file to use'
  c.option '--out [Output File]', 'HTML output for publication list'

  c.action do |args, options|
    options.default \
      :interval => 2,
      :timeout  => 60
    config    = YAML.load_file('{options.config}')
    parsed    = Rubyscholar::Parser.new(config["url"], 
                                        config["email"])
    formatter = Rubyscholar::Formatter.new(parsed, 
                                           config["highlight"], 
                                           config["pdfs"], 
                                           config["altmetricDOIs"], 
                                           config["minCitations"].to_i)
    
    html = formatter.to_html
    config["italicize"].each do |term|
      html.gsub!( term , '<em>' + term + '</em>')
    end

    f= File.open('{options.out}','w')
    f.write html
    f.close
  end
end

